# --- Powerlevel10k Instant Prompt ---
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# --- Oh My Zsh ---
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME="powerlevel10k/powerlevel10k"

# --- Plugins Configuration ---
zstyle ':omz:plugins:eza' 'git-status' yes
zstyle ':omz:plugins:eza' 'header' yes
zstyle ':omz:plugins:eza' 'icons' yes
zstyle ':omz:plugins:eza' 'color-scale' all

zstyle ':omz:plugins:alias-finder' autoload yes
zstyle ':omz:plugins:alias-finder' exact yes

ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#636DA6"
ZSH_AUTOSUGGEST_STRATEGY=completion

plugins=(
  alias-finder
  aliases
  azure
  colored-man-pages
  command-not-found
  docker
  docker-compose
  eza
  git
  helm
  jsontools
  kubectl
  pip
  python
  rails
  rake
  ruby
  web-search
  z
  zsh-autopair
  zsh-autosuggestions
  zsh-history-substring-search
  zsh-syntax-highlighting
  zsh-vi-mode
)

source $ZSH/oh-my-zsh.sh

# --- Editor Configuration ---
if command -v nvim >/dev/null 2>&1; then
  export EDITOR="nvim"
elif command -v vim >/dev/null 2>&1; then
  export EDITOR="vim"
else
  export EDITOR="vi"
fi

# --- Aliases ---
alias vim="nvim"
e() {
  "$EDITOR" "$@"
}
if command -v bat &> /dev/null; then
  alias cat="bat --theme=Dracula"
elif command -v batcat &> /dev/null; then
  alias cat="batcat"
fi
alias ll='ls -la --total-size'
alias la='ls -a'
alias lt='ls --tree'
d() {
  if ! docker info > /dev/null 2>&1; then
    if command -v colima > /dev/null; then
      colima start
    elif command -v open > /dev/null && [ -d "/Applications/Docker.app" ]; then
      open -a Docker
    elif command -v systemctl > /dev/null; then
      sudo systemctl start docker
    else
      echo "No Docker backend found (colima, Docker Desktop, or systemd)."
      return 1
    fi

    until docker info > /dev/null 2>&1; do
      sleep 1
    done
  fi

  command -v lazydocker > /dev/null || { echo "lazydocker is not installed."; return 1; }
  lazydocker
}
alias g="lazygit"
alias y="yadm enter lazygit"
alias j="just"
alias jl="just --list"
alias ju="just update"

x() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
	yazi "$@" --cwd-file="$tmp"
	if cwd="$(command cat -- "$tmp")" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
		builtin cd -- "$cwd"
	fi
	rm -f -- "$tmp"
}

zi() {
  local dir
  dir=$(z | awk '{$1=""; sub(/^ +/, ""); print }' | fzf --tac --preview 'eza -gh --git --icons=auto --color=always --color-scale=all --tree "$(echo {})" | head -80')
  [[ -n "$dir" ]] && cd "$dir"
}

vdpip () {
    local vd_path
    vd_path=$(brew --prefix visidata 2>/dev/null)

    if [[ -z "$vd_path" ]]; then
        echo "VisiData not found via Homebrew."
        return 1
    fi

    local vdp_python="$vd_path/libexec/bin/python3"

    if [[ ! -x "$vdp_python" ]]; then
        echo "Embedded Python not found at: $vdp_python"
        return 1
    fi

    "$vdp_python" -m pip "$@"
}

# --- Bindkeys ---
bindkey -v
bindkey '^x' clear-screen
bindkey '^h' vi-backward-char
bindkey '^l' vi-forward-char
bindkey -M vicmd ';' edit-command-line
bindkey -M vicmd 'k' history-substring-search-up
bindkey -M vicmd 'j' history-substring-search-down

# --- Zsh Vi Mode Colors ---
ZVM_VI_HIGHLIGHT_FOREGROUND=#82AAFF
ZVM_VI_HIGHLIGHT_BACKGROUND=#636DA6

# --- Prompt ---
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# --- Source scripts --

scripts_dir="${0:A:h}/zshrc.os"

setopt null_glob
for script in "$scripts_dir"/*.sh; do
    [[ "$script" == *"##"* ]] && continue
    [[ -r "$script" ]] && source "$script"
done
unsetopt null_glob

alias lynx="lynx -cfg=$HOME/.config/lynx/lynx.cfg -lss=$HOME/.config/lynx/lynx.lss"
if [ "$(yadm config local.class)" == "Personal" ]; then
  alias vpnify="/Applications/Vpnify.app/Contents/MacOS/CLI/vpnify"
fi
if [ "$(yadm config local.class)" == "42" ]; then
  alias cclean='bash ~/LinuxCleaner_42.sh'
fi
